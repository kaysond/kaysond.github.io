---
draft: true
title: "Debugging a One-In-A-Million Silicon Failure"
---

## Introduction
Integrated circuit designers rely completely on mathematical simulations to estimate the behavior of a circuit. The circuits are so large, and the mathematical models so complex, that it's simply impossible to do a thorough analysis by hand. [Finfet transistor models](http://bsim.berkeley.edu/models/bsimcmg/), for example, contain hundreds of parameters and hundreds of equations that define the relationships between voltages and currents in the device. The simulation software reads in a text-based representation of the entire circuit (the "netlist"), and iteratively solves the massive system of differential equations governing the circuit's behavior using linear algebra and techniques like [Newton's Method](https://en.wikipedia.org/wiki/Newton%27s_method). The calculation procedure is not unlike [Finite Element Analysis](https://en.wikipedia.org/wiki/Finite_element_method) that is used in other fields. The simulator determines every voltage and every current in every device, and outputs a selection to a database that we can easily use to perform calculations and plot waveforms. Simulators support many different analyses, including: DC, which solves for the steady-state voltages and currents; Transient, which generates voltage and current waveforms showing behavior over time; and AC, which uses approximations in transistor models to perform a frequency-domain analysis that descrbies voltage and current behaviors given a "small signal" sinusoidal stimulus that sits on top of a DC operating point.

But what happens when the simulations are incorrect? The models we use come straight from the foundries that ultimately manufacture the integrated circuits, like TSMC or Samsung. However, we often see behaviors in the final product that don't match what we simulated. There are many cases where we simply can't include everything in a simulation because it takes too long. Adding the resistance and capacitance of all the tiny wires connecting transistors together, or the inductance of the wires connecting the silicon die to its protective plastic package's pins, is a surefire way to make your simulation take weeks or even months. These "parasitics" are really there, though, so omitting them results in a less accurate simulation. Generally we are aware of these shortcomings in the design process, and we do what we can to make sure there is enough margin to account for what we can't include. Sometimes, though, the models fail to capture the full extent of variation in the manufacturing process, and that's where things get tricky.

## Variation, Corners, and Monte Carlo
Integrated circuits are manufactured in a tightly-controlled yet still inconsistent process. The manufacturing process occurs layer by layer, but the layer height is never exactly as designed. This affects the resistance and capacitance of the tiny wires as well as some properties of transistors and other devices. There is also inaccuracy in the [lithography](https://en.wikipedia.org/wiki/Photolithography), which causes the manufactured circuit elements to vary from the design dimensions we submit to the foundry. As transistors get smaller and smaller, so too does the total amount of [dopant](https://en.wikipedia.org/wiki/Doping_(semiconductor)) (an element used to make the silicon substrate "positive" or "negative") used in each device. Eventually, being off by even a few atoms can cause a significant difference! There are two main methodologies designers use to check the effects of these and other variations, enabled by specific sets of models: Corners, and Monte Carlo.

### Corners
Most silicon design occurs in a [CMOS](https://en.wikipedia.org/wiki/CMOS) process, where the C, complementary, means the process has both n-type and p-type transistors (NMOS and PMOS). Very roughly speaking, NMOS turn on when a high voltage is applied, and PMOS, a low voltage. We combine these two types of transistors into all manners of analog and digital circuits. Because there are slight differences in the steps required to create each type of transistor, they can vary differently. If we create a cartesian system where the x-axis is the NMOS speed and the y-axis is the PMOS speed, each resulting silicon die will fall somewhere in that space. This methodology picks the extremes, or the corners, of the possibile outcomes, and creates additional models representing those points. Foundries typically provide five different base transistor models. Each is denoted by a two letter code, the first of which describes the speed of the NMOS transistors, and the second the PMOS. The letters are T - typical, F - fast, and S - slow. I've annotated the five models below.

![transistor corners](/images/003/corners.png)

We use these extra models to simulate our circuits at all of these corners and see what, if anything breaks. If it works at all of the corners, it should work anywhere in between. It's important to note that in these corner models, each individual parameter of a transistor is skewed in whichever direction will make the transistor faster for F models or slower for S models. In reality, those parameters will all skew independently and randomly in any direction. This is another way in which these models are a "corner", but it does leave a hole in simulation coverage: there could be a combination of transistor parameter skews that cancel each other out in terms of "speed", but cause problems for other reasons. This is addressed by Monte Carlo, which I will describe later.

There is also the matter of passive devices - mainly resistors and capacitors, since inductors are usually custom designed. Foundries usually skew resistors and capacitors in the same direction as transistors in a given corner. At slow corners, resistors and capacitors will be larger; at fast corners, smaller. There indeed are some manufacturing variances that would cause this matched variation, but generally they vary independently. For this reason designers will often manually vary their resistors and capacitors in separate directions from the transistors.

In addition to manufacturing process, the two other key variations that we designers check are voltage and temperature (combined, "PVT"). Again, we pick the extremes: usually -40C and 125C for temperature, and whatever the minimum and maximum expected voltage are. Finally, there may be some other error sources that we want to account for, usually caused by other circuits that interact with ours.

Time and resource permitting, we simulate every combination of these extremes, which represents all of the corners of the N-dimensional "cube" that is all possible conditions of the circuit.

### Monte Carlo
